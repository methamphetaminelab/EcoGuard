Документация для бота EcoGuard

EcoGuard — это Telegram-бот, который помогает пользователям анализировать текстовые данные и изображения, содержащиеся в PDF и DOCX файлах. Бот использует Yandex GPT для ответа на вопросы, заданные пользователем на основе загруженных документов.
Установка и настройка

    Установите необходимые библиотеки: telebot, requests, PyPDF2, Pillow, и python-docx.
    В config.py укажите следующие параметры:
        BOT_TOKEN: токен вашего Telegram-бота.
        YANDEX_GPT_API_URL: URL API Yandex GPT.
        IAM_TOKEN: IAM токен для авторизации Yandex GPT.
        FOLDER_ID: ID папки в Yandex Cloud.

Основные функции
1. start_message

    Описание: Обработчик команды /start, который приветствует пользователя и запрашивает документ.
    Параметры:
        message: объект сообщения Telegram.
    Поведение: Отправляет приветственное сообщение и объясняет, как отправить документ для анализа.

2. handle_document

    Описание: Обрабатывает загруженные пользователем документы.
    Параметры:
        message: объект сообщения с документом.
    Поведение:
        Определяет тип документа (PDF или DOCX).
        Сохраняет файл локально и извлекает текст.
        Если в PDF содержатся изображения, они сохраняются и передаются на OCR обработку.
        После обработки отправляет сообщение пользователю с подтверждением успешного анализа документа.

3. handle_text

    Описание: Обрабатывает текстовые сообщения пользователей.
    Параметры:
        message: объект текстового сообщения.
    Поведение:
        Проверяет, загрузил ли пользователь документ.
        Если документ загружен, отправляет запрос к Yandex GPT на основе содержимого файла и возвращает ответ пользователю.
        Если документ не загружен, просит сначала загрузить файл для анализа.

4. send_long_message

    Описание: Отправляет длинные сообщения частями.
    Параметры:
        chat_id: ID чата.
        text: текст, который нужно отправить.
    Поведение: Делит текст на части по 4096 символов (максимальный размер сообщения Telegram) и отправляет каждую часть отдельно.

5. extract_text_from_pdf

    Описание: Извлекает текст из PDF файла.
    Параметры:
        file_path: путь к PDF файлу.
    Поведение:
        Извлекает текст из каждого листа PDF файла.
        Сохраняет изображения, если они есть, и добавляет их текстовое содержимое (через OCR) к основному тексту документа.

6. extract_text_from_docx

    Описание: Извлекает текст из DOCX файла.
    Параметры:
        file_path: путь к DOCX файлу.
    Поведение: Преобразует содержимое документа в текст.

7. process_image

    Описание: Обрабатывает изображения и извлекает текст с помощью OCR.
    Параметры:
        image_path: путь к изображению.
    Возвращает: строку с распознанным текстом.
    Поведение: Использует Tesseract OCR для распознавания текста на изображениях (с указанием языка).

8. truncate_text

    Описание: Ограничивает текст до определенного количества токенов.
    Параметры:
        text: текст для усечения.
        max_tokens: максимальное количество токенов (по умолчанию 3800).
    Возвращает: усеченный текст.
    Поведение: Делит текст на токены и возвращает часть, не превышающую указанный лимит.

9. query_yandex_gpt

    Описание: Формирует запрос к Yandex GPT на основе контекста документа и запроса пользователя.
    Параметры:
        extracted_text: текст, извлеченный из документа.
        user_message: запрос пользователя.
        user_id: ID пользователя.
    Возвращает: ответ от Yandex GPT.
    Поведение:
        Делит текст на части по max_chars символов.
        Отправляет запросы к Yandex GPT для каждого фрагмента текста и собирает ответы.
        Возвращает итоговый ответ, объединяя все фрагменты.

Запуск бота

    Основная точка входа запускает бота с none_stop=True, что позволяет ему обрабатывать сообщения без остановки:

    python

    if __name__ == '__main__':
        print("Запущено")
        bot.polling(none_stop=True)

Пример конфигурации (config.py)

python

BOT_TOKEN = 'ваш_токен_телеграм_бота'
YANDEX_GPT_API_URL = 'https://api.yandex.cloud/v1/some_endpoint'
IAM_TOKEN = 'ваш_IAM_токен'
FOLDER_ID = 'ваш_ID_папки'
